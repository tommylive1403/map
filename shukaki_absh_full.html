<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–°–æ–±–∞–∫–∏ –®—É–∫–∞–∫–∏ ‚Äî –ê–ª–≥–æ—Ä–∏—Ç–º –ë–µ–∑–ø–µ–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    :root {
      --bg-main: #0b0e12;
      --bg-panel: #1f2a37;
      --accent: #ffd166;
      --accent-soft: rgba(255, 209, 102, 0.12);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --danger: #ef4444;
      --warning: #f59e0b;
      --ok: #22c55e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */

    header {
      padding: 12px 20px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(10px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      box-shadow: 0 0 18px rgba(255, 209, 102, 0.35);
    }

    .brand-text-main {
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 14px;
    }

    .brand-text-sub {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 6px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(15, 23, 42, 0.75);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--ok);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.9);
    }

    .btn-donate {
      background: var(--accent);
      border-radius: 999px;
      padding: 7px 16px;
      border: none;
      color: #1f2933;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      box-shadow:
        0 0 18px rgba(255, 209, 102, 0.55),
        0 0 2px rgba(0, 0, 0, 0.8);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-donate span {
      font-size: 14px;
    }

    .btn-donate:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 26px rgba(255, 209, 102, 0.7),
        0 0 4px rgba(0, 0, 0, 0.8);
    }

    /* LAYOUT */

    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      min-height: 0;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
    }

    /* SIDE PANEL */

    .sidebar {
      background: linear-gradient(180deg, #020617 0, #020617 14%, #0b1120 100%);
      border-right: 1px solid rgba(30, 64, 175, 0.3);
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .status-card {
      border-radius: 14px;
      padding: 12px 12px;
      background: radial-gradient(circle at top left, #111827 0, #020617 50%);
      border: 1px solid rgba(55, 65, 81, 0.7);
      box-shadow: 0 0 22px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .status-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-main {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.75);
    }

    .status-chip strong {
      color: var(--accent);
      font-weight: 600;
    }

    .status-grid {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .status-mini {
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    .status-mini-label {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 9px;
    }

    .status-mini-value {
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .status-mini-value span {
      font-size: 11px;
    }

    .status-mini-value strong {
      font-size: 12px;
    }

    .status-mini-tag {
      font-size: 9px;
      color: var(--text-muted);
    }

    .badge-risk {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid var(--warning);
      color: var(--warning);
      background: rgba(251, 191, 36, 0.06);
    }

    .badge-risk.danger {
      border-color: var(--danger);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.08);
    }

    .badge-risk.ok {
      border-color: var(--ok);
      color: #bbf7d0;
      background: rgba(16, 185, 129, 0.08);
    }

    /* THREAT LIST */

    .threat-list {
      margin-top: 4px;
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px dashed rgba(75, 85, 99, 0.9);
      max-height: 260px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .threat-item {
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 1px;
      font-size: 11px;
    }

    .threat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .threat-title {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 11px;
    }

    .threat-type {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .threat-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    .threat-tag {
      font-size: 9px;
      text-transform: uppercase;
      color: var(--accent);
    }

    .hint {
      margin-top: 2px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .hint strong {
      color: var(--accent);
      font-weight: 500;
    }

    /* MAP AREA */

    .map-wrapper {
      position: relative;
      min-height: 0;
      background: #020617;
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: 260px;
      z-index: 1;
    }

    .map-overlay-top {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 800;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .map-mode-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .map-mode-pill strong {
      color: var(--accent);
    }

    .map-speed-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .map-speed-pill button {
      border: none;
      background: transparent;
      color: var(--accent);
      font-size: 11px;
      cursor: pointer;
      padding: 2px 4px;
    }

    .map-overlay-bottom {
      position: absolute;
      bottom: 8px;
      left: 8px;
      z-index: 800;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: min(420px, 100% - 16px);
    }

    .map-log {
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.86);
      color: var(--text-muted);
      border: 1px solid rgba(55, 65, 81, 0.9);
      max-height: 90px;
      overflow: auto;
    }

    .map-log strong {
      color: var(--accent);
    }

    .map-tip {
      font-size: 10px;
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.85);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(55, 65, 81, 0.9);
      width: fit-content;
    }

    /* Leaflet overrides */
    .leaflet-control-attribution {
      font-size: 9px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-logo">üêï</div>
      <div>
        <div class="brand-text-main">–°–æ–±–∞–∫–∏ –®—É–∫–∞–∫–∏</div>
        <div class="brand-text-sub">–ê–ª–≥–æ—Ä–∏—Ç–º –±–µ–∑–ø–µ–∫–∏ ¬∑ –ê–ë–® v0.1</div>
      </div>
    </div>

    <div class="header-right">
      <div class="pill">
        <div class="pill-dot" id="pill-dot"></div>
        LIVE ¬∑ –ú–∞–ø–∞ –Ω–µ–±–µ–∑–ø–µ–∫
      </div>
      <button class="btn-donate" onclick="alert('–¢—É—Ç –º–æ–∂–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –±–∞–Ω–∫—É / –¥–æ–Ω–∞—Ç üôÇ')">
        <span>‚ö°</span> –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª
      </button>
    </div>
  </header>

  <main class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="sidebar-section-title">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω</div>
        <div class="status-card">
          <div class="status-top">
            <div>
              <div class="status-label">–°—Ç–∞–Ω —Å–µ–∫—Ç–æ—Ä–∞</div>
              <div class="status-main">
                <span id="status-emoji">üü¢</span>
                <span id="status-text">–°–ø–æ–∫—ñ–π–Ω–æ</span>
              </div>
            </div>
            <div id="risk-badge" class="badge-risk ok">–†–∏–∑–∏–∫ –Ω–∏–∑—å–∫–∏–π</div>
          </div>

          <div class="status-chip">
            RISK SCORE: <strong id="risk-score">0</strong>/100
          </div>

          <div class="status-grid">
            <div class="status-mini">
              <div class="status-mini-label">–¶—ñ–ª—ñ</div>
              <div class="status-mini-value">
                <strong id="targets-count">0</strong>
                <span>–∞–∫—Ç–∏–≤–Ω–∏—Ö</span>
              </div>
              <div class="status-mini-tag" id="targets-tag">–Ω–µ–º–∞—î –∑–∞–≥—Ä–æ–∑</div>
            </div>

            <div class="status-mini">
              <div class="status-mini-label">–†–ï–ë</div>
              <div class="status-mini-value">
                <strong id="rew-level-text">–Ω–∏–∑—å–∫–∏–π</strong>
              </div>
              <div class="status-mini-tag" id="rew-tag">–∫–∞–Ω–∞–ª–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ</div>
            </div>

            <div class="status-mini">
              <div class="status-mini-label">–ü–æ–≥–æ–¥–∞</div>
              <div class="status-mini-value">
                <strong id="wx-short">OK</strong>
              </div>
              <div class="status-mini-tag" id="wx-tag">–Ω–µ–º–∞—î –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ñ–∞–∫—Ç–æ—Ä—ñ–≤</div>
            </div>

            <div class="status-mini">
              <div class="status-mini-label">–í—ñ–∫–Ω–æ –ø–æ–ª—å–æ—Ç—É</div>
              <div class="status-mini-value">
                <strong id="flight-window">20 —Ö–≤</strong>
              </div>
              <div class="status-mini-tag" id="flight-tag">—É–º–æ–≤–Ω–æ –±–µ–∑–ø–µ—á–Ω–æ</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="sidebar-section-title">–î–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≥—Ä–æ–∑</div>
        <div class="threat-list" id="threat-list">
          <!-- JS –¥–æ–¥–∞—î –µ–ª–µ–º–µ–Ω—Ç–∏ -->
        </div>
        <div class="hint">
          üí° <strong>–ü–æ—Ä–∞–¥–∞:</strong> –∫–ª—ñ–∫ –ø–æ –º–∞–ø—ñ –¥–æ–¥–∞—î —Ç–µ—Å—Ç–æ–≤—É ‚Äú–∑–∞–≥—Ä–æ–∑—É‚Äù (–∫–æ—Ä–∏—Å–Ω–æ, —â–æ–± –ø–æ–≥—Ä–∞—Ç–∏—Å—å –∑ –ª–æ–≥—ñ–∫–æ—é —Ä–∏–∑–∏–∫—É).
        </div>
      </div>
    </aside>

    <!-- MAP -->
    <section class="map-wrapper">
      <div id="map"></div>

      <div class="map-overlay-top">
        <div class="map-mode-pill">
          –†–µ–∂–∏–º: <strong>–ê–ë–® ¬∑ –∞–µ—Ä–æ—Ä–æ–∑–≤—ñ–¥–∫–∞</strong>
        </div>
        <div class="map-speed-pill">
          –ù–ê–ñ–ò–í–û ¬∑ 1x
          <button type="button" onclick="togglePulse()">‚èØ</button>
        </div>
      </div>

      <div class="map-overlay-bottom">
        <div class="map-log" id="map-log">
          <strong>–õ–æ–≥ –ê–ë–®:</strong> —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞–ª–≥–æ—Ä–∏—Ç–º—É –±–µ–∑–ø–µ–∫–∏‚Ä¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–æ–≤–∏—Ö –∑–∞–≥—Ä–æ–∑.
        </div>
        <div class="map-tip">
          üëÜ –ù–∞—Ç–∏—Å–Ω–∏ –ø–æ –º–∞–ø—ñ ‚Äî –¥–æ–¥–∞–º–æ —Ç—Ä–µ–Ω—É–≤–∞–ª—å–Ω—É –∑–∞–≥—Ä–æ–∑—É –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ä–∏–∑–∏–∫—É.
        </div>
      </div>
    </section>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ========= –¢–ï–°–¢–û–í–Ü –î–ê–ù–Ü –ó–ê–ì–†–û–ó =========

    const THREAT_TYPES = {
      SHAHED: {
        label: "Shahed / –¥—Ä–æ–Ω-–∫–∞–º—ñ–∫–∞–¥–∑–µ",
        emoji: "üõ∞Ô∏è",
        color: "#f97316",
        baseRisk: 30,
        short: "–î—Ä–æ–Ω-–∫–∞–º—ñ–∫–∞–¥–∑–µ"
      },
      CRUISE: {
        label: "–ö—Ä–∏–ª–∞—Ç–∞ —Ä–∞–∫–µ—Ç–∞",
        emoji: "üöÄ",
        color: "#ef4444",
        baseRisk: 40,
        short: "–ö—Ä–∏–ª–∞—Ç–∞ —Ä–∞–∫–µ—Ç–∞"
      },
      ARTY: {
        label: "–ê—Ä—Ç–∏–ª–µ—Ä—ñ–π—Å—å–∫–∏–π –æ–±—Å—Ç—Ä—ñ–ª",
        emoji: "üí•",
        color: "#e5e7eb",
        baseRisk: 20,
        short: "–ê—Ä—Ç–æ–±—Å—Ç—Ä—ñ–ª"
      },
      REW: {
        label: "–ê–∫—Ç–∏–≤–Ω–∏–π –†–ï–ë",
        emoji: "üì°",
        color: "#22c55e",
        baseRisk: 15,
        short: "–†–ï–ë"
      },
      FPV: {
        label: "FPV-–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å",
        emoji: "üéØ",
        color: "#22d3ee",
        baseRisk: 25,
        short: "FPV"
      }
    };

    let threats = [
      {
        id: "t1",
        type: "SHAHED",
        desc: "–ô–º–æ–≤—ñ—Ä–Ω–∏–π –ø—Ä–æ–ª—ñ—Ç Shahed –ø–æ –æ—Å—ñ –ø—ñ–≤–¥–µ–Ω—å ‚Üí —Ü–µ–Ω—Ç—Ä",
        intensity: 0.9,
        lat: 49.5,
        lng: 31,
        distKm: 60
      },
      {
        id: "t2",
        type: "ARTY",
        desc: "–õ–æ–∫–∞–ª—å–Ω–∏–π –∞—Ä—Ç–æ–±—Å—Ç—Ä—ñ–ª –≤ —Å–µ–∫—Ç–æ—Ä—ñ —Å—Ö—ñ–¥",
        intensity: 0.6,
        lat: 48.9,
        lng: 37.7,
        distKm: 12
      },
      {
        id: "t3",
        type: "REW",
        desc: "–ü–æ—Å–∏–ª–µ–Ω–Ω—è –†–ï–ë, –º–æ–∂–ª–∏–≤—ñ –∑–±–æ—ó –∑–≤ º—è–∑–∫—É –∑ –¥—Ä–æ–Ω–æ–º",
        intensity: 0.7,
        lat: 47.9,
        lng: 35,
        distKm: 8
      }
    ];

    let map, threatLayer;
    let pulseInterval = null;

    // ========= –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ú–ê–ü–ò =========

    function initMap() {
      map = L.map("map", {
        zoomControl: true,
        minZoom: 5,
        maxZoom: 12
      }).setView([48.5, 31.2], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(map);

      threatLayer = L.layerGroup().addTo(map);

      map.on("click", onMapClick);

      renderThreats();
      updateRiskAndUI();
      logEvent("–ú–∞–ø—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ. –ó–∞–≥—Ä–æ–∑–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.");
    }

    // ========= –†–û–ë–û–¢–ê –ó –ó–ê–ì–†–û–ó–ê–ú–ò =========

    function renderThreats() {
      threatLayer.clearLayers();

      threats.forEach((t) => {
        const meta = THREAT_TYPES[t.type];
        if (!meta) return;

        const marker = L.circleMarker([t.lat, t.lng], {
          radius: 8 + t.intensity * 4,
          color: meta.color,
          weight: 2,
          opacity: 0.9,
          fillColor: meta.color,
          fillOpacity: 0.35
        });

        const popupHtml = `
          <div style="font-size:12px;">
            <strong>${meta.emoji} ${meta.label}</strong><br/>
            <span>${t.desc}</span><br/>
            <span style="color:#9ca3af;">–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å: ${(t.intensity * 100).toFixed(0)}%</span><br/>
            <span style="color:#9ca3af;">–í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –≥—Ä—É–ø–∏: ${t.distKm.toFixed(1)} –∫–º</span>
          </div>
        `;

        marker.bindPopup(popupHtml);
        marker.addTo(threatLayer);
      });

      renderThreatList();
    }

    function renderThreatList() {
      const list = document.getElementById("threat-list");
      list.innerHTML = "";

      if (!threats.length) {
        list.innerHTML =
          '<div class="threat-item"><div class="threat-header"><div class="threat-title"><span>‚úÖ</span><span>–ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑ –Ω–µ–º–∞—î</span></div></div><div class="threat-meta">–ê–ë–® –Ω–µ —Ñ—ñ–∫—Å—É—î —Å—É—Ç—Ç—î–≤–∏—Ö —Ä–∏–∑–∏–∫—ñ–≤ —É —Å–µ–∫—Ç–æ—Ä—ñ.</div></div>';
        return;
      }

      threats.forEach((t) => {
        const meta = THREAT_TYPES[t.type];
        if (!meta) return;

        const risk = computeThreatRiskScore(t);
        const riskLabel =
          risk > 70 ? "–≤–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫" : risk > 40 ? "—Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫" : "–Ω–∏–∑—å–∫–∏–π —Ä–∏–∑–∏–∫";

        const item = document.createElement("div");
        item.className = "threat-item";
        item.innerHTML = `
          <div class="threat-header">
            <div class="threat-title">
              <span>${meta.emoji}</span>
              <span>${meta.short}</span>
            </div>
            <div class="threat-type">${riskLabel}</div>
          </div>
          <div class="threat-meta">${t.desc}</div>
          <div class="threat-meta">
            –Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å: ${(t.intensity * 100).toFixed(0)}% ¬∑ –í—ñ–¥—Å—Ç–∞–Ω—å: ${t.distKm.toFixed(
              1
            )} –∫–º
          </div>
          <div class="threat-tag">RISK SCORE: ${risk.toFixed(0)}/100</div>
        `;
        list.appendChild(item);
      });
    }

    function computeThreatRiskScore(t) {
      const meta = THREAT_TYPES[t.type];
      if (!meta) return 0;

      // –±–∞–∑–æ–≤–∏–π —Ä–∏–∑–∏–∫ —Ç–∏–ø—É
      let score = meta.baseRisk;

      // –∫–æ—Ä–∏–≥—É—î–º–æ –∑–∞ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—é
      score *= 0.7 + t.intensity * 0.6; // 70‚Äì130%

      // –∫–æ—Ä–∏–≥—É—î–º–æ –∑–∞ –≤—ñ–¥—Å—Ç–∞–Ω–Ω—é (—á–∏–º –±–ª–∏–∂—á–µ ‚Äî —Ç–∏–º –≥—ñ—Ä—à–µ)
      if (t.distKm < 10) score *= 1.3;
      else if (t.distKm < 25) score *= 1.1;
      else if (t.distKm > 70) score *= 0.8;

      return Math.min(100, score);
    }

    function computeGlobalRisk(threats) {
      if (!threats.length) return 0;
      // –±–µ—Ä–µ–º–æ —â–æ—Å—å –º—ñ–∂ max —ñ —Å–µ—Ä–µ–¥–Ω—ñ–º
      const scores = threats.map(computeThreatRiskScore);
      const max = Math.max(...scores);
      const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
      return Math.round((max * 0.6 + avg * 0.4) * 0.95); // —Ç—Ä–æ—Ö–∏ –∑–º–µ–Ω—à—É—î–º–æ
    }

    // ========= –û–ù–û–í–õ–ï–ù–ù–Ø UI =========

    function updateRiskAndUI() {
      const risk = computeGlobalRisk(threats);

      const riskScoreEl = document.getElementById("risk-score");
      const statusEmojiEl = document.getElementById("status-emoji");
      const statusTextEl = document.getElementById("status-text");
      const riskBadgeEl = document.getElementById("risk-badge");
      const targetsCountEl = document.getElementById("targets-count");
      const targetsTagEl = document.getElementById("targets-tag");
      const rewLevelTextEl = document.getElementById("rew-level-text");
      const rewTagEl = document.getElementById("rew-tag");
      const wxShortEl = document.getElementById("wx-short");
      const wxTagEl = document.getElementById("wx-tag");
      const flightWindowEl = document.getElementById("flight-window");
      const flightTagEl = document.getElementById("flight-tag");
      const pillDot = document.getElementById("pill-dot");

      riskScoreEl.textContent = risk;

      let statusEmoji = "üü¢";
      let statusText = "–°–ø–æ–∫—ñ–π–Ω–æ";
      let riskBadgeText = "–†–∏–∑–∏–∫ –Ω–∏–∑—å–∫–∏–π";
      let riskBadgeClass = "badge-risk ok";

      if (risk <= 20) {
        statusEmoji = "üü¢";
        statusText = "–°–ø–æ–∫—ñ–π–Ω–æ";
        riskBadgeText = "–†–∏–∑–∏–∫ –Ω–∏–∑—å–∫–∏–π";
        riskBadgeClass = "badge-risk ok";
      } else if (risk <= 40) {
        statusEmoji = "üü°";
        statusText = "–û–±–µ—Ä–µ–∂–Ω–æ";
        riskBadgeText = "–†–∏–∑–∏–∫ –ø–æ–º—ñ—Ä–Ω–∏–π";
        riskBadgeClass = "badge-risk";
      } else if (risk <= 65) {
        statusEmoji = "üü†";
        statusText = "–ù–µ—Å—Ç–∞–±—ñ–ª—å–Ω–æ";
        riskBadgeText = "–†–∏–∑–∏–∫ –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π";
        riskBadgeClass = "badge-risk";
      } else {
        statusEmoji = "üî¥";
        statusText = "–ù–µ–±–µ–∑–ø–µ—á–Ω–æ";
        riskBadgeText = "–†–∏–∑–∏–∫ –∫—Ä–∏—Ç–∏—á–Ω–∏–π";
        riskBadgeClass = "badge-risk danger";
      }

      statusEmojiEl.textContent = statusEmoji;
      statusTextEl.textContent = statusText;
      riskBadgeEl.textContent = riskBadgeText;
      riskBadgeEl.className = riskBadgeClass;

      // –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ü—ñ–ª–µ–π
      targetsCountEl.textContent = threats.length;
      if (!threats.length) {
        targetsTagEl.textContent = "–Ω–µ–º–∞—î –∑–∞–≥—Ä–æ–∑";
      } else {
        const types = new Set(threats.map((t) => THREAT_TYPES[t.type]?.short));
        targetsTagEl.textContent = Array.from(types).join(" ¬∑ ");
      }

      // —Ä—ñ–≤–µ–Ω—å –†–ï–ë ‚Äî –¥–∏–≤–∏–º–æ—Å—å –ø–æ –∑–∞–≥—Ä–æ–∑–∞—Ö —Ç–∏–ø—É REW
      const rewThreats = threats.filter((t) => t.type === "REW");
      let rewText = "–Ω–∏–∑—å–∫–∏–π";
      let rewTag = "–∫–∞–Ω–∞–ª–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ";

      if (rewThreats.length) {
        const maxRew = Math.max(...rewThreats.map((t) => t.intensity));
        if (maxRew < 0.35) {
          rewText = "–Ω–∏–∑—å–∫–∏–π";
          rewTag = "–∫–∞–Ω–∞–ª–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ";
        } else if (maxRew < 0.7) {
          rewText = "—Å–µ—Ä–µ–¥–Ω—ñ–π";
          rewTag = "–º–æ–∂–ª–∏–≤—ñ –∑–±–æ—ó –∫–∞–Ω–∞–ª—É –∑–≤ º—è–∑–∫—É";
        } else {
          rewText = "–≤–∏—Å–æ–∫–∏–π";
          rewTag = "—Ä–∏–∑–∏–∫ –≤—Ç—Ä–∞—Ç–∏ –¥—Ä–æ–Ω–∞ —á–µ—Ä–µ–∑ –†–ï–ë";
        }
      }

      rewLevelTextEl.textContent = rewText;
      rewTagEl.textContent = rewTag;

      // –ø–æ–≥–æ–¥–∞ ‚Äî –ø–æ–∫–∏ —â–æ —Ñ–µ–π–∫, –º–æ–∂–Ω–∞ –ø–æ—Ç—ñ–º –ø—ñ–¥ º—î–¥–Ω–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω–∏–π API
      wxShortEl.textContent = "OK";
      wxTagEl.textContent = "–≤—ñ—Ç–µ—Ä –≤ –Ω–æ—Ä–º—ñ ¬∑ –≤–∏–¥–∏–º—ñ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–Ω—è";

      // –≤—ñ–∫–Ω–æ –ø–æ–ª—å–æ—Ç—É (—á–∏–º –±—ñ–ª—å—à–∏–π risk, —Ç–∏–º –∫–æ—Ä–æ—Ç—à–µ –≤—ñ–∫–Ω–æ)
      let flightMin = 25;
      if (risk > 20 && risk <= 40) flightMin = 18;
      else if (risk > 40 && risk <= 65) flightMin = 10;
      else if (risk > 65) flightMin = 4;

      flightWindowEl.textContent = flightMin + " —Ö–≤";
      flightTagEl.textContent =
        risk <= 40 ? "—É–º–æ–≤–Ω–æ –±–µ–∑–ø–µ—á–Ω–æ" : risk <= 65 ? "—Ä–∏–∑–∏–∫–æ–≤–∞–Ω–æ, –∫–æ—Ä–æ—Ç–∫—ñ –≤–∏–ª—å–æ—Ç–∏" : "–ª–∏—à–µ –∫—Ä–∏—Ç–∏—á–Ω—ñ –∑–∞–¥–∞—á—ñ";

      // –∫–æ–ª—ñ—Ä –ª–∞–π–≤-—Ç–æ—á–∫–∏
      if (risk <= 40) {
        pillDot.style.background = "var(--ok)";
        pillDot.style.boxShadow = "0 0 8px rgba(16,185,129,0.9)";
      } else if (risk <= 65) {
        pillDot.style.background = "var(--warning)";
        pillDot.style.boxShadow = "0 0 8px rgba(245,158,11,0.9)";
      } else {
        pillDot.style.background = "var(--danger)";
        pillDot.style.boxShadow = "0 0 8px rgba(239,68,68,0.9)";
      }
    }

    // ========= –õ–û–ì–ò =========

    function logEvent(message) {
      const logEl = document.getElementById("map-log");
      const now = new Date();
      const ts = now.toTimeString().slice(0, 8);
      const line = `[${ts}] ${message}`;
      logEl.innerHTML = `<strong>–õ–æ–≥ –ê–ë–®:</strong><br>` + line + "<br>" + logEl.innerHTML.split("<br>").slice(2, 20).join("<br>");
    }

    // ========= –Ü–ù–¢–ï–†–ê–ö–¶–Ü–Ø –ó –ú–ê–ü–û–Æ =========

    function onMapClick(e) {
      // –¥–æ–¥–∞—î–º–æ —Ç—Ä–µ–Ω—É–≤–∞–ª—å–Ω—É FPV –∑–∞–≥—Ä–æ–∑—É –≤ —Ç–æ—á—Ü—ñ –∫–ª—ñ–∫—É
      const newThreat = {
        id: "click-" + Date.now(),
        type: "FPV",
        desc: "–¢—Ä–µ–Ω—É–≤–∞–ª—å–Ω–∞ FPV-–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (–¥–æ–¥–∞–Ω–æ –∫–ª—ñ–∫–æ–º –ø–æ –º–∞–ø—ñ)",
        intensity: 0.4 + Math.random() * 0.5,
        lat: e.latlng.lat,
        lng: e.latlng.lng,
        distKm: 5 + Math.random() * 25
      };

      threats.push(newThreat);
      renderThreats();
      updateRiskAndUI();
      logEvent("–î–æ–¥–∞–Ω–æ —Ç—Ä–µ–Ω—É–≤–∞–ª—å–Ω—É FPV-–∑–∞–≥—Ä–æ–∑—É —É —Ç–æ—á—Ü—ñ –∫–ª—ñ–∫—É.");
    }

    // ========= –ü–£–õ–¨–° / LIVE =========

    function togglePulse() {
      if (pulseInterval) {
        clearInterval(pulseInterval);
        pulseInterval = null;
        logEvent("‚è∏ –ü—É–ª—å—Å –ê–ë–® –∑—É–ø–∏–Ω–µ–Ω–æ.");
        return;
      }
      pulseInterval = setInterval(() => {
        // —Ç—Ä–æ—à–∫–∏ ‚Äú–¥–∏—Ö–∞—î–º–æ‚Äù —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—é –∑–∞–≥—Ä–æ–∑
        threats = threats.map((t) => {
          const delta = (Math.random() - 0.5) * 0.12;
          let newIntensity = t.intensity + delta;
          newIntensity = Math.max(0.2, Math.min(1, newIntensity));
          return { ...t, intensity: newIntensity };
        });
        renderThreats();
        updateRiskAndUI();
      }, 3500);
      logEvent("‚ñ∂ –ü—É–ª—å—Å –ê–ë–® —É–≤—ñ–º–∫–Ω–µ–Ω–æ (—ñ–º—ñ—Ç–∞—Ü—ñ—è –∑–º—ñ–Ω–∏ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—ñ –∑–∞–≥—Ä–æ–∑).");
    }

    // ========= START =========

    document.addEventListener("DOMContentLoaded", initMap);
  </script>
</body>
</html>
